name: CD Pipeline - Blue-Green Deployment

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      deploy-environment:
        description: 'Environment to deploy'
        required: true
        default: 'qa'
        type: choice
        options:
        - qa
        - staging
        - production

env:
  IMAGE_NAME: bp-calculator
  REGISTRY: ghcr.io

permissions:
  contents: read
  issues: write

jobs:
  # =====================
  # CI PHASE
  # =====================
  continuous-integration:
    runs-on: ubuntu-latest
    outputs:
      docker-tag: ${{ steps.version.outputs.docker-tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Generate Docker tag
        id: version
        run: |
          SHORT_SHA=${GITHUB_SHA::8}
          TAG="build-$(date +%Y%m%d)-${SHORT_SHA}"
          echo "docker-tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"

      - name: Restore dependencies
        run: dotnet restore ./bp-calculator.sln

      - name: Build solution
        run: dotnet build ./bp-calculator.sln --configuration Release --no-restore

      - name: Run tests
        run: dotnet test ./BP.Tests/BP.Tests.csproj --configuration Release --no-build --verbosity normal

      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME:${{ steps.version.outputs.docker-tag }} .
          docker build -t $IMAGE_NAME:latest .

      - name: Test Docker image
        run: |
          docker run -d --name test-container -p 8080:8080 $IMAGE_NAME:${{ steps.version.outputs.docker-tag }}
          sleep 10
          echo "Testing application health..."
          curl -f http://localhost:8080/health || (echo "Health check failed" && exit 1)
          docker stop test-container
          docker rm test-container
          echo "Docker image verified"

      - name: Save Docker image
        run: docker save $IMAGE_NAME:${{ steps.version.outputs.docker-tag }} > docker-image.tar

      - name: Upload Docker artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: docker-image.tar
          retention-days: 3

  # =====================
  # PERFORMANCE & PENETRATION TESTING (MERGED)
  # =====================
  performance-and-penetration-testing:
    runs-on: ubuntu-latest
    needs: continuous-integration
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load < docker-image.tar

      - name: Start application container
        run: |
          docker run -d --name bp-app -p 8080:8080 $IMAGE_NAME:${{ needs.continuous-integration.outputs.docker-tag }}
          echo "Application container started"

      - name: Wait for application health
        run: |
          echo "Waiting for application to be healthy..."
          for i in {1..12}; do
            if curl -s -f http://localhost:8080/health > /dev/null; then
              echo "‚úÖ Application is healthy!"
              break
            fi
            echo "‚è≥ Waiting for application... Attempt $i/12"
            sleep 5
          done

      - name: Install k6 for performance testing
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates gnupg
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/k6.gpg
          echo "deb [signed-by=/etc/apt/keyrings/k6.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Run Health Check Performance Test
        run: |
          echo "Starting Health Check Performance Test..."
          k6 run ./PerformanceTests/health-check-test.js

      - name: Install security tools for penetration testing
        run: |
          sudo apt-get update
          sudo apt-get install -y nmap curl

      - name: Network Security Scan
        run: |
          echo "üîç Running network security scan..."
          nmap -sV -sC localhost -p 8080

      - name: API Security Headers Test
        run: |
          echo "üîí Testing API security headers..."
          curl -I http://localhost:8080/health
          echo "Security headers check completed"

      - name: SQL Injection Protection Test
        run: |
          echo "üö´ Testing SQL injection protection..."
          
          # Test BP API for SQL injection
          echo "Testing BP Calculator API..."
          curl -X POST http://localhost:8080/api/bp/calculate \
            -H "Content-Type: application/json" \
            -d '{"Systolic": "120 OR 1=1", "Diastolic": 80}' || echo "‚úÖ BP API - SQL injection blocked"
          
          # Test BMI API for SQL injection
          echo "Testing BMI Calculator API..."
          curl -X POST http://localhost:8080/api/bmi/calculate \
            -H "Content-Type: application/json" \
            -d '{"Weight": "70 UNION SELECT", "Height": 1.75}' || echo "‚úÖ BMI API - SQL injection blocked"

      - name: Input Validation Testing
        run: |
          echo "üß™ Testing input validation..."
          
          # Test extreme values for BP API
          echo "Testing BP API input validation..."
          curl -X POST http://localhost:8080/api/bp/calculate \
            -H "Content-Type: application/json" \
            -d '{"Systolic": 1000, "Diastolic": 500}' || echo "‚úÖ BP API - Extreme values rejected"
          
          # Test extreme values for BMI API
          echo "Testing BMI API input validation..."
          curl -X POST http://localhost:8080/api/bmi/calculate \
            -H "Content-Type: application/json" \
            -d '{"Weight": 1000, "Height": 0.1}' || echo "‚úÖ BMI API - Extreme values rejected"

      - name: HTTP Method Security Test
        run: |
          echo "üåê Testing HTTP methods security..."
          
          # Test unwanted HTTP methods on BP API
          curl -X PUT http://localhost:8080/api/bp/calculate || echo "‚úÖ PUT method rejected"
          curl -X DELETE http://localhost:8080/api/bp/calculate || echo "‚úÖ DELETE method rejected"
          curl -X PATCH http://localhost:8080/api/bp/calculate || echo "‚úÖ PATCH method rejected"
          
          # Test unwanted HTTP methods on BMI API
          curl -X PUT http://localhost:8080/api/bmi/calculate || echo "‚úÖ PUT method rejected"
          curl -X DELETE http://localhost:8080/api/bmi/calculate || echo "‚úÖ DELETE method rejected"

      - name: XSS Protection Test
        run: |
          echo "üõ°Ô∏è Testing XSS protection..."
          
          # Test for XSS attempts
          curl -X POST http://localhost:8080/api/bp/calculate \
            -H "Content-Type: application/json" \
            -d '{"Systolic": "<script>alert(1)</script>", "Diastolic": 80}' || echo "‚úÖ XSS attempt blocked"

      - name: Cleanup containers
        run: |
          docker stop bp-app || true
          docker rm bp-app || true

      - name: Testing Summary
        run: |
          echo "‚úÖ PERFORMANCE & PENETRATION TESTING COMPLETED"
          echo "üìä Performance Tests:"
          echo "   - Health Check: 10 users for 1 minute"
          echo "üîí Penetration Tests:"
          echo "   - Network security scan"
          echo "   - API security headers"
          echo "   - SQL injection protection"
          echo "   - Input validation"
          echo "   - HTTP method security"
          echo "   - XSS protection"

  # =====================
  # RELEASE MANAGEMENT - BLUE-GREEN ONLY
  # =====================
  
  deploy-qa:
    runs-on: ubuntu-latest
    needs: [continuous-integration, performance-and-penetration-testing]
    environment: qa
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load and deploy to QA
        run: |
          docker load < docker-image.tar
          docker stop bp-qa || true
          docker rm bp-qa || true
          docker run -d --name bp-qa -p 8080:8080 -e ASPNETCORE_ENVIRONMENT=Development $IMAGE_NAME:${{ needs.continuous-integration.outputs.docker-tag }}
          echo "Deployed to QA environment"

      - name: Verify QA deployment
        run: |
          echo "Waiting for QA service..."
          timeout 60s bash -c 'until curl -f http://localhost:8080/health; do sleep 5; done'
          echo "QA deployment verified"

  deploy-staging:
    runs-on: ubuntu-latest
    needs: [continuous-integration, deploy-qa, performance-and-penetration-testing]
    environment: staging
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load < docker-image.tar

      - name: Blue-Green Deployment
        run: |
          set -e
          DEPLOY_TAG="${{ needs.continuous-integration.outputs.docker-tag }}"
          
          if docker ps --format "table {{.Names}}" | grep -q "bp-staging-blue"; then
            CURRENT="blue"
            NEW="green"
            NEW_PORT="8082"
            OLD_PORT="8081"
          else
            CURRENT="green"
            NEW="blue"
            NEW_PORT="8081"
            OLD_PORT="8082"
          fi
          echo "Current active: $CURRENT, Deploying to: $NEW"
          docker run -d --name bp-staging-$NEW -p $NEW_PORT:8080 -e ASPNETCORE_ENVIRONMENT=Staging $IMAGE_NAME:$DEPLOY_TAG
          timeout 60s bash -c "until curl -f http://localhost:$NEW_PORT/health >/dev/null 2>&1; do sleep 5; done"
          docker stop bp-staging-$CURRENT || true
          docker rm bp-staging-$CURRENT || true
          echo "Blue-Green deployment completed successfully"

  deploy-production:
    runs-on: ubuntu-latest
    needs: [continuous-integration, deploy-staging, performance-and-penetration-testing]
    environment: production
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load < docker-image.tar

      - name: Blue-Green Production Deployment
        run: |
          set -e
          echo "Starting Blue-Green Production Deployment..."
          
          DEPLOY_TAG="${{ needs.continuous-integration.outputs.docker-tag }}"
          
          # Determine current active environment
          if docker ps --format "table {{.Names}}" | grep -q "bp-production-blue"; then
            CURRENT="blue"
            NEW="green"
            NEW_PORT="8082"
            OLD_PORT="8081"
          else
            CURRENT="green"
            NEW="blue"
            NEW_PORT="8081"
            OLD_PORT="8082"
          fi
          
          echo "Current production: $CURRENT (port $OLD_PORT), Deploying to: $NEW (port $NEW_PORT)"
          
          # Deploy to new environment
          docker run -d --name bp-production-$NEW -p $NEW_PORT:8080 -e ASPNETCORE_ENVIRONMENT=Production $IMAGE_NAME:$DEPLOY_TAG
          
          # Wait for new deployment to be healthy
          echo "Waiting for new production environment to be ready..."
          for i in {1..12}; do
            echo "Health check attempt $i for $NEW environment..."
            
            # Check if container is still running
            if ! docker ps | grep -q "bp-production-$NEW"; then
              echo " New production container has stopped unexpectedly"
              echo "Container logs:"
              docker logs bp-production-$NEW
              exit 1
            fi
            
            # Try health check
            if curl -f http://localhost:$NEW_PORT/health >/dev/null 2>&1; then
              echo " New production environment is healthy!"
              break
            fi
            
            if [ $i -eq 12 ]; then
              echo " New production environment failed health checks after 60 seconds"
              echo "Container logs:"
              docker logs bp-production-$NEW
              exit 1
            fi
            
            sleep 5
          done
          
          # Switch traffic by stopping old environment
          echo "Switching traffic to new environment..."
          docker stop bp-production-$CURRENT || true
          docker rm bp-production-$CURRENT || true
          
          echo " Blue-Green production deployment completed successfully"

      - name: Production verification
        run: |
          echo "=== Final Production Verification ==="
          echo "Active production containers:"
          docker ps --filter "name=bp-production" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          # Determine which environment is currently active
          if docker ps --format "table {{.Names}}" | grep -q "bp-production-blue"; then
            ACTIVE_PORT="8081"
            ACTIVE_ENV="blue"
          else
            ACTIVE_PORT="8082" 
            ACTIVE_ENV="green"
          fi
          
          echo "Active production environment: $ACTIVE_ENV (port $ACTIVE_PORT)"
          
          echo "Testing health endpoint..."
          curl -f http://localhost:$ACTIVE_PORT/health
          echo ""
          echo " Production deployment successful and verified!"